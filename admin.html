<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Inventario</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="src/css/admin.css" />
</head>
<body class="container py-4">

  <h2>Gestión de Inventario</h2>
  <button class="btn btn-danger mb-3" onclick="cerrarSesion()">Cerrar sesión</button>

  <!-- Tabla de Inventario -->
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Producto</th>
        <th>Stock</th>
        <th>Min Stock</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody id="inventarioAdmin">
      <!-- Aquí se inyectarán los productos -->
    </tbody>
  </table>

  <!-- Historial de pedidos -->
  <div id="historialSection">
    <h3 class="text-center mb-4">Historial de Pedidos</h3>
    <div id="contenidoHistorial">
      <ul id="listaHistorial" class="list-group mb-3"></ul>
      <p><strong>Total Recolectado:</strong> $<span id="totalRecaudado">0.00</span></p>
    </div>
    <button id="btnPDF" class="btn btn-warning mb-4">Descargar Historial en PDF</button>

    <hr>

    <!-- Resumen por día -->
    <h4 class="mt-4">Resumen de productos vendidos por día</h4>
    <div id="resumenVentas">
      <table class="table table-bordered mt-3">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Producto</th>
            <th>Cantidad Total</th>
          </tr>
        </thead>
        <tbody id="tablaResumen"></tbody>
      </table>
      <button class="btn btn-success mb-4" id="descargarResumen">Descargar Resumen en PDF</button>

      <!-- Aquí agregamos el canvas para el gráfico -->
      <canvas id="graficoVentas" style="max-width: 100%; height: 400px;"></canvas>
    </div>
  </div>

  <!-- Scripts -->
  <script src="src/assets/js/log.js"></script>
  <script>
    let chartVentas; // Variable global para el gráfico

    function cerrarSesion() {
      localStorage.clear();
      window.location.href = 'login.html';
    }

    // Mostrar historial
    function mostrarHistorial() {
      const historial = JSON.parse(localStorage.getItem('historialPedidos')) || [];
      const listaHistorial = document.getElementById('listaHistorial');
      const totalRecaudado = document.getElementById('totalRecaudado');
      let total = 0;

      listaHistorial.innerHTML = '';

      historial.forEach((pedido, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = `#${index + 1} | Mesa ${pedido.mesa} | ${pedido.producto} x${pedido.cantidad} = $${pedido.total.toFixed(2)} | ${pedido.fecha}`;
        listaHistorial.appendChild(li);
        total += pedido.total;
      });

      totalRecaudado.textContent = total.toFixed(2);
    }

    // Generar resumen por día y crear gráfico
    function generarResumenPorDia() {
      const historial = JSON.parse(localStorage.getItem('historialPedidos')) || [];
      const resumen = {}; // {fecha: {producto: cantidad}}

      historial.forEach(pedido => {
        const fecha = pedido.fecha;
        const producto = pedido.producto;
        const cantidad = pedido.cantidad;

        if (!resumen[fecha]) resumen[fecha] = {};
        if (!resumen[fecha][producto]) resumen[fecha][producto] = 0;

        resumen[fecha][producto] += cantidad;
      });

      // Ordenar fechas
      const fechasOrdenadas = Object.keys(resumen).sort();

      // Mostrar tabla resumen
      const tablaResumen = document.getElementById('tablaResumen');
      tablaResumen.innerHTML = '';

      fechasOrdenadas.forEach(fecha => {
        for (const producto in resumen[fecha]) {
          const fila = document.createElement('tr');
          fila.innerHTML = `
            <td>${fecha}</td>
            <td>${producto}</td>
            <td>${resumen[fecha][producto]}</td>
          `;
          tablaResumen.appendChild(fila);
        }
      });

      // Preparar datos para el gráfico
      // Queremos mostrar cantidad total por día, sumando todos los productos.
      const cantidadesPorFecha = fechasOrdenadas.map(fecha => {
        let totalDia = 0;
        for (const producto in resumen[fecha]) {
          totalDia += resumen[fecha][producto];
        }
        return totalDia;
      });

      // Si ya hay un gráfico creado, lo destruimos para evitar superposiciones
      if (chartVentas) {
        chartVentas.destroy();
      }

      // Crear gráfico de barras
      const ctx = document.getElementById('graficoVentas').getContext('2d');
      chartVentas = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: fechasOrdenadas,
          datasets: [{
            label: 'Cantidad total vendida por día',
            data: cantidadesPorFecha,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1,
            borderRadius: 5,
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              precision: 0,
              title: {
                display: true,
                text: 'Cantidad'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Fecha'
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
            },
            tooltip: {
              enabled: true
            }
          }
        }
      });
    }

    // Descargar historial en PDF
    document.getElementById('btnPDF').addEventListener('click', () => {
      const contenido = document.getElementById('contenidoHistorial');
      const opciones = {
        margin: 0.5,
        filename: 'historial_pedidos.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      html2pdf().set(opciones).from(contenido).save();
    });

    // Descargar resumen en PDF
    document.getElementById('descargarResumen').addEventListener('click', () => {
      const contenidoResumen = document.getElementById('resumenVentas');
      const opciones = {
        margin: 0.5,
        filename: 'resumen_ventas_por_dia.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      html2pdf().set(opciones).from(contenidoResumen).save();
    });

    // Ejecutar funciones al cargar
    document.addEventListener('DOMContentLoaded', () => {
      mostrarHistorial();
      generarResumenPorDia();
    });
  </script>
</body>
</html>
